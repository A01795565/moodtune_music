openapi: 3.0.3
info:
  title: MoodTune Music API
  version: "1.0.0"
  description: |
    API para encapsular integración con proveedores musicales (Spotify/iTunes/Amazon Music no oficial).
    Expone:
    - Creación de playlists (requiere token de usuario)
    - Búsquedas por título+artista (Client Credentials / iTunes Search / Amazon Music)
    - Parámetros por emoción
    - Resolución normalizada de canciones y audio-features (incluye Amazon Music)
  termsOfService: https://moodtune.com/terms
  contact:
    name: Equipo 26 – MoodTune
    url: https://moodtune.com/moodtune
    email: equipo26@moodtune.com

servers:
  - url: http://localhost:8020
    description: Entorno local de desarrollo

tags:
  - name: Health
  - name: Playlists
  - name: Catalog
  - name: Auth

paths:
  /:
    get:
      tags: [Health]
      summary: Endpoint raíz - estado de aplicación
      operationId: musicRoot
      security: []
      responses:
        "200":
          description: OK
          content:
            application/json:
              schema:
                type: object
                properties:
                  name: { type: string, example: moodtune_music }
                  status: { type: string, example: ok }

  /health:
    get:
      tags: [Health]
      summary: Healthcheck
      operationId: musicHealth
      security: []
      responses:
        "200": { description: OK, content: { application/json: { schema: { $ref: "#/components/schemas/HealthResponse" } } } }

  /playlists:
    post:
      tags: [Playlists]
      summary: Crear playlist en proveedor especificado y agregar tracks
      operationId: createPlaylist
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/CreatePlaylistRequest"
      responses:
        "201": { description: Creada, content: { application/json: { schema: { $ref: "#/components/schemas/CreatePlaylistResponse" } } } }
        "400": { description: Error de validación, content: { application/json: { schema: { $ref: "#/components/schemas/Error" } } } }
        "502": { description: Error proveedor, content: { application/json: { schema: { $ref: "#/components/schemas/Error" } } } }

  /playlists/moodtune:
    post:
      tags: [Playlists]
      summary: Crear playlist con metadatos MoodTune (user_id, inference_id, intention, emotion)
      operationId: createPlaylistMoodtune
      description: |
        Endpoint especializado para que el frontend de MoodTune guarde playlists completas con metadatos adicionales.
        Funciona igual que POST /playlists pero retorna información adicional de MoodTune.
      requestBody:
        required: true
        content:
          application/json:
            schema:
              allOf:
                - $ref: "#/components/schemas/CreatePlaylistRequest"
                - type: object
                  properties:
                    user_id: { type: string, format: uuid, description: ID de usuario MoodTune }
                    inference_id: { type: string, format: uuid, description: ID de inferencia FER }
                    intention: { type: string, description: Intención del usuario }
                    emotion: { type: string, description: Emoción detectada }
      responses:
        "201":
          description: Creada
          content:
            application/json:
              schema:
                allOf:
                  - $ref: "#/components/schemas/CreatePlaylistResponse"
                  - type: object
                    properties:
                      user_id: { type: string, format: uuid }
                      inference_id: { type: string, format: uuid }
                      intention: { type: string }
                      emotion: { type: string }
        "400": { description: Error de validación, content: { application/json: { schema: { $ref: "#/components/schemas/Error" } } } }
        "502": { description: Error proveedor, content: { application/json: { schema: { $ref: "#/components/schemas/Error" } } } }

  /playlists/content:
    post:
      tags: [Playlists]
      summary: Obtener contenido de una playlist existente
      operationId: getPlaylistContent
      description: |
        Recupera una playlist del proveedor externo para mostrarla en el frontend.
        Obtiene información completa incluyendo tracks, imágenes y metadatos.
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                provider: { type: string, enum: [spotify, amazon_music, apple_music], description: Proveedor musical }
                external_playlist_id: { type: string, description: ID de la playlist en el proveedor }
                provider_access_token: { type: string, description: Token de acceso (opcional) }
              required: [external_playlist_id]
      responses:
        "200":
          description: Contenido de la playlist
          content:
            application/json:
              schema:
                type: object
                properties:
                  provider: { type: string }
                  playlist_id: { type: string }
                  title: { type: string }
                  description: { type: string, nullable: true }
                  owner: { type: string }
                  tracks:
                    type: array
                    items:
                      type: object
                      properties:
                        id: { type: string }
                        uri: { type: string }
                        title: { type: string }
                        artist: { type: string }
                        album: { type: string }
                        duration_ms: { type: integer }
                        preview_url: { type: string, nullable: true }
                        image_url: { type: string, nullable: true }
                        external_urls: { type: object }
                        added_at: { type: string, format: date-time }
                  tracks_total: { type: integer }
                  images: { type: array, items: { type: object } }
                  external_url: { type: string }
        "400": { description: Error de validación, content: { application/json: { schema: { $ref: "#/components/schemas/Error" } } } }
        "502": { description: Error proveedor, content: { application/json: { schema: { $ref: "#/components/schemas/Error" } } } }

  /catalog/emotions:
    get:
      tags: [Catalog]
      summary: Listado de emociones y parámetros
      operationId: catalogListEmotions
      responses:
        "200":
          description: OK
          content:
            application/json:
              schema:
                type: object
                properties:
                  items:
                    type: object
                    additionalProperties:
                      type: object
                      properties:
                        valence:
                          type: array
                          items: { type: number }
                        energy:
                          type: array
                          items: { type: number }

  /catalog/emotions/{emotion}:
    get:
      tags: [Catalog]
      summary: Parámetros para una emoción específica
      operationId: catalogEmotionParams
      parameters:
        - in: path
          name: emotion
          required: true
          schema: { type: string }
      responses:
        "200":
          description: OK
          content:
            application/json:
              schema:
                type: object
                properties:
                  emotion: { type: string }
                  params:
                    type: object
                    properties:
                      valence:
                        type: array
                        items: { type: number }
                      energy:
                        type: array
                        items: { type: number }
        "404": { description: No encontrado, content: { application/json: { schema: { $ref: "#/components/schemas/Error" } } } }

  /catalog/resolve:
    post:
      tags: [Catalog]
      summary: Resolver título+artista a pista normalizada (proveedor controlado por .env)
      operationId: catalogResolve
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                title: { type: string, example: "Fix You" }
                artist: { type: string, example: "Coldplay" }
                limit: { type: integer, example: 1 }
              required: [title, artist]
      responses:
        "200": { description: OK, content: { application/json: { schema: { $ref: "#/components/schemas/ResolveResponse" } } } }
        "400": { description: Error, content: { application/json: { schema: { $ref: "#/components/schemas/Error" } } } }

  /catalog/resolve-batch:
    post:
      tags: [Catalog]
      summary: Resolver en lote varios título+artista (proveedor controlado por .env)
      operationId: catalogResolveBatch
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                items:
                  type: array
                  items:
                    type: object
                    properties:
                      title: { type: string }
                      artist: { type: string }
                per_item_limit: { type: integer, default: 1 }
              required: [items]
      responses:
        "200": { description: OK, content: { application/json: { schema: { $ref: "#/components/schemas/ResolveBatchResponse" } } } }
        "400": { description: Error, content: { application/json: { schema: { $ref: "#/components/schemas/Error" } } } }

  /catalog/audio-features:
    post:
      tags: [Catalog]
      summary: Audio-features para lista de IDs (Spotify por defecto, acepta amazon_music)
      operationId: catalogAudioFeatures
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                ids:
                  type: array
                  items: { type: string }
                provider:
                  type: string
                  enum: [spotify, amazon_music]
                  description: Proveedor que entregará los audio-features; omitir para usar Spotify.
      responses:
        "200": { description: OK, content: { application/json: { schema: { $ref: "#/components/schemas/AudioFeaturesResponse" } } } }
        "400": { description: Error, content: { application/json: { schema: { $ref: "#/components/schemas/Error" } } } }

  /catalog/search-spotify:
    post:
      tags: [Catalog]
      summary: Búsqueda simple de canciones en Spotify (Client Credentials)
      operationId: catalogSearchSpotify
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                title: { type: string, example: "Fix You" }
                artist: { type: string, example: "Coldplay" }
                limit: { type: integer, example: 1 }
              required: [title, artist]
      responses:
        "200":
          description: OK
          content:
            application/json:
              schema:
                type: object
                properties:
                  items:
                    type: array
                    items: { type: object }
                  returned: { type: integer }
        "400": { description: Error, content: { application/json: { schema: { $ref: "#/components/schemas/Error" } } } }

  /catalog/search-amazon:
    post:
      tags: [Catalog]
      summary: BÁsqueda simple de canciones en Amazon Music (Client Credentials)
      operationId: catalogSearchAmazon
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                title: { type: string, example: "Fix You" }
                artist: { type: string, example: "Coldplay" }
                limit: { type: integer, example: 1 }
              required: [title, artist]
      responses:
        "200":
          description: OK
          content:
            application/json:
              schema:
                type: object
                properties:
                  items:
                    type: array
                    items: { type: object }
                  returned: { type: integer }
        "400": { description: Error, content: { application/json: { schema: { $ref: "#/components/schemas/Error" } } } }

  /catalog/search-itunes:
    post:
      tags: [Catalog]
      summary: Búsqueda simple de canciones en iTunes Search API
      operationId: catalogSearchItunes
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                title: { type: string, example: "Fix You" }
                artist: { type: string, example: "Coldplay" }
                limit: { type: integer, example: 1 }
              required: [title, artist]
      responses:
        "200":
          description: OK
          content:
            application/json:
              schema:
                type: object
                properties:
                  items:
                    type: array
                    items: { type: object }
                  returned: { type: integer }
        "400": { description: Error, content: { application/json: { schema: { $ref: "#/components/schemas/Error" } } } }

  /auth/spotify:
    get:
      tags: [Auth]
      summary: Inicia OAuth flow con Spotify usando PKCE
      operationId: authSpotifyGet
      description: |
        Genera URL de autorización de Spotify con PKCE (Proof Key for Code Exchange).
        Almacena el estado y code_verifier para validación posterior en el callback.
      parameters:
        - in: query
          name: redirect_uri
          schema: { type: string }
          required: false
          description: URI de redirección (usa SPOTIFY_AUTH_REDIRECT_URI si no se provee)
        - in: query
          name: scope
          schema: { type: string }
          description: Scopes solicitados (default playlist-modify-public playlist-modify-private)
        - in: query
          name: callback_url
          schema: { type: string }
          description: URL del frontend para redirección final (default FRONTEND_CALLBACK_URL)
      responses:
        "200":
          description: URL de autorización construida
          content:
            application/json:
              schema:
                type: object
                properties:
                  authorize_url: { type: string }
                  state: { type: string, description: Estado único para validación }
                required: [authorize_url, state]
        "400": { description: Redirect URI requerido, content: { application/json: { schema: { $ref: "#/components/schemas/Error" } } } }
        "500": { description: Configuración incompleta, content: { application/json: { schema: { $ref: "#/components/schemas/Error" } } } }

  /auth/spotify/callback:
    get:
      tags: [Auth]
      summary: Callback de OAuth de Spotify
      operationId: authSpotifyCallback
      description: |
        Recibe el código de autorización de Spotify, lo intercambia por tokens
        y redirige al frontend con los tokens en el URL hash.
      parameters:
        - in: query
          name: code
          schema: { type: string }
          required: true
          description: Código de autorización de Spotify
        - in: query
          name: state
          schema: { type: string }
          required: true
          description: Estado generado en /auth/spotify
        - in: query
          name: error
          schema: { type: string }
          required: false
          description: Error si usuario deniega autorización
      responses:
        "302":
          description: Redirección al frontend con tokens o error
          headers:
            Location:
              schema:
                type: string
                example: "http://localhost:5173/create-playlist#access_token=TOKEN&refresh_token=REFRESH&expires_in=3600"

  /auth/spotify/refresh:
    post:
      tags: [Auth]
      summary: Refrescar token de acceso de Spotify
      operationId: authSpotifyRefresh
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                refresh_token: { type: string }
              required: [refresh_token]
      responses:
        "200":
          description: Token refrescado
          content:
            application/json:
              schema:
                type: object
                properties:
                  provider: { type: string, example: spotify }
                  token_type: { type: string, example: Bearer }
                  scope: { type: string }
                  access_token: { type: string }
                  refresh_token: { type: string }
                  expires_in: { type: integer }
        "400": { description: Refresh token requerido, content: { application/json: { schema: { $ref: "#/components/schemas/Error" } } } }
        "502": { description: Error de Spotify, content: { application/json: { schema: { $ref: "#/components/schemas/Error" } } } }

  /auth/amazon:
    get:
      tags: [Auth]
      summary: Construye la URL de autorización de Amazon Music para iniciar OAuth
      operationId: authAmazonGet
      parameters:
        - in: query
          name: redirect_uri
          schema: { type: string, example: "https://localhost:8020/auth/amazon/callback" }
          required: false
          description: URI de retorno que debe coincidir con la registrada en Amazon. Se puede definir como variable de entorno.
        - in: query
          name: scope
          schema: { type: string, example: "music::library:read" }
          description: Scopes solicitados; se usa `AMAZON_MUSIC_AUTH_SCOPE` si no se provee.
      responses:
        "200":
          description: URL de autorización construida
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/AuthorizationUrlResponse"
        "400": { description: Redirect URI requerido, content: { application/json: { schema: { $ref: "#/components/schemas/Error" } } } }
        "500": { description: Configuración incompleta, content: { application/json: { schema: { $ref: "#/components/schemas/Error" } } } }

components:
  schemas:
    HealthResponse:
      type: object
      properties:
        status: { type: string, example: ok }
        service: { type: string, example: moodtune_music }
        debug: { type: boolean }

    Error:
      type: object
      properties:
        error: { type: string }
        detail: { type: string }

    CreatePlaylistRequest:
      type: object
      properties:
        provider: { type: string, example: spotify }
        provider_access_token: { type: string }
        title: { type: string }
        description: { type: string }
        uris:
          type: array
          items: { type: string }
      required: [provider_access_token, title, uris]

    CreatePlaylistResponse:
      type: object
      properties:
        provider: { type: string }
        external_playlist_id: { type: string }
        deep_link_url: { type: string }
        title: { type: string }
        description: { type: string }
        tracks_added: { type: integer }

    AudioFeaturesResponse:
      type: object
      properties:
        items:
          type: object
          additionalProperties:
            type: object
            properties:
              valence: { type: number, format: float }
              energy: { type: number, format: float }

    ResolveItem:
      type: object
      properties:
        id: { type: string, nullable: true }
        external_id: { type: string, nullable: true }
        provider: { type: string, enum: [itunes, spotify, amazon_music] }
        source: { type: string, example: amazon_music_search }
        title: { type: string }
        artist: { type: string }
        uri: { type: string, nullable: true }
        preview_url: { type: string, nullable: true }
        image_url: { type: string, nullable: true }
        thumbnail_url: { type: string, nullable: true }

    ResolveResponse:
      type: object
      properties:
        items:
          type: array
          items: { $ref: "#/components/schemas/ResolveItem" }
        returned: { type: integer }

    ResolveBatchResponse:
      type: object
      properties:
        items:
          type: array
          items:
            type: object
            properties:
              index: { type: integer }
              title: { type: string }
              artist: { type: string }
              items:
                type: array
                items: { $ref: "#/components/schemas/ResolveItem" }
        returned: { type: integer }

    AuthorizationUrlResponse:
      type: object
      properties:
        authorize_url: { type: string }
      required: [authorize_url]
